import warnings
import argparse
from sklearn.metrics import classification_report
from module.dataset import dataset_operation
from module.metrix import output_metrix_from_matrix
from module.schema import (
    CaseLabel,
    PretrainedModel,
    ClassifyModel,
    AdditionalMechanism,
)
from model.base import BaseModel
from model.fine_tuning import FineTuning
from model.sparse_attention import DynamicSpatialAttention
from model.cbam import CbamAttention
from model.umap import SupervisedUMAP


warnings.filterwarnings("ignore")


def basic(parse_args, x_train, y_train, x_test, y_test):
    """
    Model Preparation
    """
    model = BaseModel(
        x_train=x_train,
        y_train=y_train,
        x_test=x_test,
        parse_args=parse_args,
    )

    """
    Learning & Prediction
    """
    if parse_args.case == CaseLabel.CATEGORY:
        if parse_args.classify == "fcn":
            y_pred = model.flow_execute()
            output_metrix_from_matrix(y_test=y_test, y_pred=y_pred)
        else:
            for pretrained_model in [
                "vgg16", "vgg19", "resnet152", "efficientnet_v2",
                "densenet201", "xception", "inception_v3",
                # "small_mobilenet_v3", "efficientnet_v2",
            ]:
                model.convolutional_model = pretrained_model
                for classify_func in [
                    "svc", "rf", "xgboost", "svm"
                    # "svm", "svc", "rf",
                    # "knn", "j48", "xgboost",
                ]:
                    model.classify_func = classify_func
                    y_pred = model.flow_execute()
                    output_metrix_from_matrix(y_test=y_test, y_pred=y_pred)
    else:  # BINARY Case
        if parse_args.augmentation:
            if parse_args.classify == "fcn":
                for pretrained_model in [
                    "vgg16", "vgg19", "resnet152", "efficientnet_v2",
                    "densenet201", "xception", "inception_v3",
                    # "small_mobilenet_v3", "efficientnet_v2",
                ]:
                    model.convolutional_model = pretrained_model
                    y_pred = model.flow_execute()
                    print(classification_report(y_test, y_pred, target_names=['Benign', 'Malware'], digits=4))
            else:
                for pretrained_model in [
                    "vgg16", "vgg19", "resnet152", "efficientnet_v2",
                    "densenet201", "xception", "inception_v3",
                    # "small_mobilenet_v3", "efficientnet_v2",
                ]:
                    model.convolutional_model = pretrained_model
                    for classify_func in [
                        "svc", "rf", "xgboost", "svm"
                        # "svm", "svc", "rf",
                        # "knn", "j48", "xgboost",
                    ]:
                        model.classify_func = classify_func
                        y_pred = model.flow_execute()
                        print(classification_report(y_test, y_pred, target_names=['Benign', 'Malware'], digits=4))
        elif parse_args.umap:
            del model
            model = SupervisedUMAP(
                x_train=x_train,
                y_train=y_train,
                x_test=x_test,
                parse_args=parse_args,
            )
            y_pred = model.flow_execute()
            print(classification_report(y_test, y_pred, target_names=['Benign', 'Malware'], digits=4))
        else:
            y_pred = model.flow_execute()
            print(classification_report(y_test, y_pred, target_names=['Benign', 'Malware'], digits=4))


def fine_tuning(parse_args, x_train, y_train, x_test, y_test):
    """
    Model Preparation
    """
    model = FineTuning(
        x_train=x_train,
        y_train=y_train,
        x_test=x_test,
        parse_args=parse_args,
    )

    """
    Learning & Prediction
    """
    if parse_args.classify == "fcn":
        if parse_args.case == CaseLabel.CATEGORY:
            y_pred = model.flow_execute()
            output_metrix_from_matrix(y_test=y_test, y_pred=y_pred)
        else:
            y_pred = model.flow_execute()
            print(classification_report(y_test, y_pred, target_names=['Benign', 'Malware'], digits=4))

    else:  # svm, svc, rf, knn, j48, xgboost
        raise NotImplementedError


def spatial(parse_args, x_train, y_train, x_test, y_test):
    """
    Model Preparation
    """
    model = DynamicSpatialAttention(
        x_train=x_train,
        y_train=y_train,
        x_test=x_test,
        parse_args=parse_args,
    )

    """
    Learning & Prediction
    """
    if parse_args.case == CaseLabel.CATEGORY:
        # fcn
        if parse_args.classify == "fcn":
            for pretrained_model in [
                "vgg16", "vgg19", "resnet152",
                "densenet201", "xception", "inception_v3", "efficientnet_v2",
                # "small_mobilenet_v3", "efficientnet_v2",
            ]:
                model.convolutional_model = pretrained_model
                y_pred = model.flow_execute()
                output_metrix_from_matrix(y_test=y_test, y_pred=y_pred)
        # svm, svc, rf, knn, j48, xgboost
        else:
            raise NotImplementedError

    else:  # Binary Case
        # fcn
        if parse_args.classify == "fcn":
            for pretrained_model in [
                "vgg16", "vgg19", "resnet152",
                "densenet201", "xception", "inception_v3", "efficientnet_v2",
                # "small_mobilenet_v3", "efficientnet_v2",
            ]:
                model.convolutional_model = pretrained_model
                y_pred = model.flow_execute()
                print(classification_report(y_test, y_pred, target_names=['Benign', 'Malware'], digits=4))
        # svm, svc, rf, knn, j48, xgboost
        else:
            raise NotImplementedError


def cbam(parse_args, x_train, y_train, x_test, y_test):
    """
    Model Preparation
    """
    model = CbamAttention(
        x_train=x_train,
        y_train=y_train,
        x_test=x_test,
        parse_args=parse_args,
    )

    """
    Learning & Prediction
    """
    if parse_args.case == CaseLabel.CATEGORY:
        # fcn
        if parse_args.classify == "fcn":
            for pretrained_model in [
                "vgg16", "vgg19", "resnet152",
                "densenet201", "xception", "inception_v3", "efficientnet_v2",
                # "small_mobilenet_v3", "efficientnet_v2",
            ]:
                model.convolutional_model = pretrained_model
                y_pred = model.flow_execute()
                output_metrix_from_matrix(y_test=y_test, y_pred=y_pred)
        # svm, svc, rf, knn, j48, xgboost
        else:
            raise NotImplementedError

    else:  # Binary Case
        # fcn
        if parse_args.classify == "fcn":
            for pretrained_model in [
                "vgg16", "vgg19", "resnet152",
                "densenet201", "xception", "inception_v3", "efficientnet_v2",
                # "small_mobilenet_v3"
            ]:
                model.convolutional_model = pretrained_model
                y_pred = model.flow_execute()
                print(classification_report(y_test, y_pred, target_names=['Benign', 'Malware'], digits=4))
        # svm, svc, rf, knn, j48, xgboost
        else:
            raise NotImplementedError


def main(parse_args):
    print(parse_args)

    x_train, y_train, x_test, y_test = dataset_operation(parse_args)

    if parse_args.addition == "spatial":
        spatial(parse_args, x_train, y_train, x_test, y_test)
    elif parse_args.addition == "cbam":
        cbam(parse_args, x_train, y_train, x_test, y_test)
    elif parse_args.addition == "tuning":
        fine_tuning(parse_args, x_train, y_train, x_test, y_test)
    elif parse_args.addition == "test":
        fine_tuning(parse_args, x_train, y_train, x_test, y_test)
    else:
        basic(parse_args, x_train, y_train, x_test, y_test)


if __name__ == "__main__":
    parser = argparse.ArgumentParser()

    parser.add_argument("-s", "--size", nargs="?", type=int, default=300, choices=[224, 300])
    parser.add_argument("-m", "--model", nargs="?", type=str, default="vgg16", choices=[ e.value for e in PretrainedModel ])
    parser.add_argument("-c", "--classify", nargs="?", type=str, default="fcn", choices=[ e.value for e in ClassifyModel ])
    parser.add_argument("-l", "--last-layer", nargs="?", type=str, default="flatten", choices=[ "flatten", "gap" ])
    parser.add_argument("-a", "--addition", nargs="?", type=str, default=None, choices=[ e.value for e in AdditionalMechanism ])

    case_parser = parser.add_subparsers(dest='case')

    """
    Binary Case
    """
    binary_case = case_parser.add_parser('binary')
    binary_case.add_argument("-f", "--fold", nargs="?", type=int, default=1, choices=[1, 2, 3])
    binary_case.add_argument("-ag", "--augmentation", action="store_true")
    binary_case.add_argument("-cs", "--cost-sensitive", action="store_true")
    binary_case.add_argument("-u", "--umap", action="store_true")

    """
    11-Category Case
    """
    category_case = case_parser.add_parser('category')

    main(parser.parse_args())
