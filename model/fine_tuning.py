import tensorflow as tf
from model.base import BaseModel


class FineTuning(BaseModel):
    def print_trainables(self, model):
        for layer in model.layers:
            print(layer.name, layer.trainable)


    def choose_convolutional_model(self):
        _, h, w, d = self.x_train.shape
        if self.convolutional_model == "vgg16":
            print("""
                    VGG16
            """)
            base_model = tf.keras.applications.VGG16(
                weights='imagenet',
                include_top=False,
                input_shape=(h, w, d)
            )
            # In addition to implement Fine-tuning
            # base_model.trainable = True
            # for i, layer in enumerate(base_model.layers):
            #     if i < 4: # 4, 7, 11, 15
            #         layer.trainable = False
            base_model.trainable = False

            self.print_trainables(base_model)


        elif self.convolutional_model == "vgg19":
            print("""
                    VGG19
            """)
            base_model = tf.keras.applications.VGG19(
                weights='imagenet',
                include_top=False,
                input_shape=(h, w, d)
            )
            self.print_trainables(base_model)

        elif self.convolutional_model == "resnet152":
            print("""
                    ResNet152
            """)
            base_model = tf.keras.applications.ResNet152(
                weights='imagenet',
                include_top=False,
                input_shape=(h, w, d)
            )
            self.print_trainables(base_model)

        elif self.convolutional_model == "densenet201":
            print("""
                    DenseNet201
            """)
            base_model = tf.keras.applications.DenseNet201(
                weights='imagenet',
                include_top=False,
                input_shape=(h, w, d)
            )
            self.print_trainables(base_model)

        elif self.convolutional_model == "xception":
            print("""
                    Xception
            """)
            base_model = tf.keras.applications.Xception(
                weights='imagenet',
                include_top=False,
                input_shape=(h, w, d)
            )
            self.print_trainables(base_model)

        elif self.convolutional_model == "inception_v3":
            print("""
                    InceptionV3
            """)
            base_model = tf.keras.applications.InceptionV3(
                weights='imagenet',
                include_top=False,
                input_shape=(h, w, d)
            )
            self.print_trainables(base_model)

        elif self.convolutional_model == "small_mobilenet_v3":
            print("""
                    MobileNetV3 Small
            """)
            base_model = tf.keras.applications.MobileNetV3Small(
                weights='imagenet',
                include_top=False,
                input_shape=(h, w, d)
            )
            self.print_trainables(base_model)

        elif self.convolutional_model == "large_mobilenet_v3":
            print("""
                    MobileNetV3 Large
            """)
            base_model = tf.keras.applications.MobileNetV3Large(
                weights='imagenet',
                include_top=False,
                input_shape=(h, w, d)
            )
            self.print_trainables(base_model)

        else:
            raise Exception("No Pretrained Model")

        return base_model


    def binary_case_basic_flow(self):
        base_model = self.choose_convolutional_model()

        model = self.choose_last_layer(base_model, 2)
        model.summary()

        model.compile(
            optimizer=tf.keras.optimizers.Adam(
                learning_rate=1e-5,
            ),
            # optimizer = tf.keras.optimizers.RMSprop(
            #     learning_rate=1e-5,
            # ),
            loss='sparse_categorical_crossentropy',
            metrics=['accuracy']
        )

        model.fit(
            x=self.x_train,
            y=self.y_train,
            batch_size=32,
            epochs=15,
            callbacks=[
                tf.keras.callbacks.EarlyStopping(monitor='loss', patience=3)
            ],
            verbose='auto'
        )
        y_pred = model.predict(self.x_test).argmax(axis=1)
        return y_pred


    def category_case_basic_flow(self):
        base_model = self.choose_convolutional_model()

        model = self.choose_last_layer(base_model, 11)
        model.summary()

        model.compile(
            optimizer=tf.keras.optimizers.Adam(
                learning_rate=1e-5,
            ),
            # optimizer = tf.keras.optimizers.RMSprop(
            #     learning_rate=1e-5,
            # ),
            loss='sparse_categorical_crossentropy',
            metrics=['accuracy']
        )

        model.fit(
            x=self.x_train,
            y=self.y_train,
            batch_size=32,
            epochs=15,
            callbacks=[
                tf.keras.callbacks.EarlyStopping(monitor='loss', patience=3)
            ],
            verbose='auto'
        )
        y_pred = model.predict(self.x_test).argmax(axis=1)
        return y_pred

